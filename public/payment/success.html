<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Success</title>
    <link rel="stylesheet" href="/assets/css/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-body">
          <h1 class="card-title">Payment Successful!</h1>
          <p>
            Your payment has been processed successfully. Your shipment is being
            created.
          </p>
          <div id="shipment-details">
            <p><strong>Shipment ID:</strong> <span id="shipment-id"></span></p>
            <p>
              <strong>Tracking Number:</strong>
              <span id="tracking-number"></span>
            </p>
          </div>
          <a
            href="/shipment/track"
            id="track-shipment-btn"
            class="btn btn-primary"
            >Track Your Shipment</a
          >
        </div>
      </div>
    </div>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentIntentClientSecret = urlParams.get(
          "payment_intent_client_secret"
        );
        const stripe = Stripe("pk_test_..."); // Replace with your publishable key

        if (paymentIntentClientSecret) {
          const { paymentIntent } = await stripe.retrievePaymentIntent(
            paymentIntentClientSecret
          );

          if (paymentIntent.status === "succeeded") {
            const shipmentData = JSON.parse(
              localStorage.getItem("shipmentData")
            );
            if (shipmentData) {
              const response = await fetch("/payment/confirm", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  paymentIntentId: paymentIntent.id,
                  shipmentData: shipmentData,
                }),
              });

              if (response.ok) {
                const result = await response.json();
                document.getElementById("shipment-id").textContent =
                  result.data.shipmentId;
                document.getElementById("tracking-number").textContent =
                  result.data.trackingId;
                const trackUrl = `/shipment/track?id=${result.data.trackingId}`;
                document.getElementById("track-shipment-btn").href = trackUrl;
                localStorage.removeItem("shipmentData");

                setTimeout(() => {
                  window.location.href = trackUrl;
                }, 3000);
              } else {
                document.getElementById("shipment-details").innerHTML =
                  "<p>There was an error creating your shipment. Please contact support.</p>";
              }
            } else {
              document.getElementById("shipment-details").innerHTML =
                "<p>Could not retrieve shipment data. Please contact support.</p>";
            }
          } else {
            document.getElementById(
              "shipment-details"
            ).innerHTML = `<p>Payment was not successful. Status: ${paymentIntent.status}</p>`;
          }
        }
      });
    </script>
  </body>
</html>
