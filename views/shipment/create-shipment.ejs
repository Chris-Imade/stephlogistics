<!-- Create Shipment Page -->
<div class="create-shipment-container">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Create New Shipment</h2>
          </div>
          <div class="card-body">
            <form id="create-shipment-form">
              <!-- Progress Indicator -->
              <div class="progress-indicator mb-4">
                <div class="progress">
                  <div
                    class="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <span class="progress-step active">1. Customer Info</span>
                  <span class="progress-step">2. Shipment Details</span>
                  <span class="progress-step">3. Package Info</span>
                  <span class="progress-step">4. Review & Pay</span>
                </div>
              </div>

              <!-- Customer Information Section -->
              <div class="section-wrapper" id="customer-info-section">
                <h3 class="section-title">Customer Information</h3>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="customer-name" class="form-label"
                      >Full Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="customer-name"
                      name="customer.name"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="customer-email" class="form-label"
                      >Email Address</label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="customer-email"
                      name="customer.email"
                      required
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="customer-phone" class="form-label"
                      >Phone Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="customer-phone"
                      name="customer.phone"
                      required
                    />
                  </div>
                </div>
                <div class="mt-4 text-end">
                  <button
                    type="button"
                    class="btn btn-primary next-section"
                    data-next="shipment-details-section"
                  >
                    Continue to Shipment Details
                  </button>
                </div>
              </div>

              <!-- Shipment Details Section -->
              <div class="section-wrapper d-none" id="shipment-details-section">
                <h3 class="section-title">Shipment Details</h3>

                <!-- Origin Address -->
                <div class="mb-4">
                  <h4 class="mb-3">Origin Address</h4>
                  <div class="row g-3">
                    <div class="col-12">
                      <label for="origin-address" class="form-label"
                        >Address</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="origin-address"
                        name="origin.address"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="origin-city" class="form-label">City</label>
                      <input
                        type="text"
                        class="form-control"
                        id="origin-city"
                        name="origin.city"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="origin-state" class="form-label"
                        >State/Province</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="origin-state"
                        name="origin.state"
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="origin-postal-code" class="form-label"
                        >Postal Code</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="origin-postal-code"
                        name="origin.postalCode"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="origin-country" class="form-label"
                        >Country</label
                      >
                      <select
                        class="form-select"
                        id="origin-country"
                        name="origin.country"
                        required
                      >
                        <option value="">Select Country</option>
                        <option value="UK">United Kingdom</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <!-- Add more countries as needed -->
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Destination Address -->
                <div class="mb-4">
                  <h4 class="mb-3">Destination Address</h4>
                  <div class="row g-3">
                    <div class="col-12">
                      <label for="destination-address" class="form-label"
                        >Address</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="destination-address"
                        name="destination.address"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="destination-city" class="form-label"
                        >City</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="destination-city"
                        name="destination.city"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="destination-state" class="form-label"
                        >State/Province</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="destination-state"
                        name="destination.state"
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="destination-postal-code" class="form-label"
                        >Postal Code</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="destination-postal-code"
                        name="destination.postalCode"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="destination-country" class="form-label"
                        >Country</label
                      >
                      <select
                        class="form-select"
                        id="destination-country"
                        name="destination.country"
                        required
                      >
                        <option value="">Select Country</option>
                        <option value="UK">United Kingdom</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <!-- Add more countries as needed -->
                      </select>
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                  <button
                    type="button"
                    class="btn btn-outline-secondary prev-section"
                    data-prev="customer-info-section"
                  >
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary next-section"
                    data-next="package-info-section"
                  >
                    Continue to Package Info
                  </button>
                </div>
              </div>

              <!-- Package Information Section -->
              <div class="section-wrapper d-none" id="package-info-section">
                <h3 class="section-title">Package Information</h3>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="package-type" class="form-label"
                      >Package Type</label
                    >
                    <select
                      class="form-select"
                      id="package-type"
                      name="package.type"
                      required
                    >
                      <option value="">Select Type</option>
                      <option value="document">Document</option>
                      <option value="package">Package</option>
                      <option value="pallet">Pallet</option>
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label for="package-weight" class="form-label"
                      >Weight</label
                    >
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="package-weight"
                        name="package.weight.value"
                        step="0.1"
                        min="0.1"
                        required
                      />
                      <select
                        class="form-select"
                        id="weight-unit"
                        name="package.weight.unit"
                      >
                        <option value="kg">kg</option>
                        <option value="lb">lb</option>
                      </select>
                    </div>
                  </div>

                  <div class="col-12">
                    <h5 class="mt-3 mb-2">Dimensions</h5>
                  </div>

                  <div class="col-md-4">
                    <label for="package-length" class="form-label"
                      >Length</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="package-length"
                      name="package.dimensions.length"
                      step="0.1"
                      min="0.1"
                      required
                    />
                  </div>

                  <div class="col-md-4">
                    <label for="package-width" class="form-label">Width</label>
                    <input
                      type="number"
                      class="form-control"
                      id="package-width"
                      name="package.dimensions.width"
                      step="0.1"
                      min="0.1"
                      required
                    />
                  </div>

                  <div class="col-md-4">
                    <label for="package-height" class="form-label"
                      >Height</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="package-height"
                      name="package.dimensions.height"
                      step="0.1"
                      min="0.1"
                      required
                    />
                  </div>

                  <div class="col-md-4">
                    <label for="dimensions-unit" class="form-label">Unit</label>
                    <select
                      class="form-select"
                      id="dimensions-unit"
                      name="package.dimensions.unit"
                    >
                      <option value="cm">cm</option>
                      <option value="in">in</option>
                    </select>
                  </div>

                  <div class="col-md-6 mt-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="is-fragile"
                        name="package.isFragile"
                      />
                      <label class="form-check-label" for="is-fragile">
                        This package contains fragile items
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mt-3">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="insurance-required"
                        name="package.insuranceRequired"
                      />
                      <label class="form-check-label" for="insurance-required">
                        I want to insure this shipment
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 insurance-value d-none">
                    <label for="declared-value" class="form-label"
                      >Declared Value</label
                    >
                    <div class="input-group">
                      <input
                        type="number"
                        class="form-control"
                        id="declared-value"
                        name="package.declaredValue.value"
                        step="0.01"
                        min="0"
                      />
                      <select
                        class="form-select"
                        id="currency"
                        name="package.declaredValue.currency"
                      >
                        <option value="USD">USD</option>
                        <option value="GBP">GBP</option>
                        <option value="EUR">EUR</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                  <button
                    type="button"
                    class="btn btn-outline-secondary prev-section"
                    data-prev="shipment-details-section"
                  >
                    Back
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary next-section"
                    data-next="review-section"
                  >
                    Continue to Review & Pay
                  </button>
                </div>
              </div>

              <!-- Review and Payment Section -->
              <div class="section-wrapper d-none" id="review-section">
                <h3 class="section-title">Review & Payment</h3>

                <!-- Shipping Options -->
                <div class="shipping-options mb-4">
                  <h4 class="mb-3">Select Shipping Method</h4>
                  <div class="row g-3" id="shipping-options-container">
                    <!-- Shipping options will be loaded here -->
                    <div class="col-md-4">
                      <div class="card h-100 shipping-option">
                        <div class="card-body">
                          <h5 class="card-title">DHL Express</h5>
                          <p class="card-text">Delivery in 1-2 business days</p>
                          <p class="price">£45.75</p>
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="radio"
                              name="shipping.carrier"
                              id="dhl-express"
                              value="DHL"
                              data-service="Express"
                              data-rate="45.75"
                              checked
                            />
                            <label class="form-check-label" for="dhl-express"
                              >Select</label
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100 shipping-option">
                        <div class="card-body">
                          <h5 class="card-title">FedEx Priority</h5>
                          <p class="card-text">Delivery in 1 business day</p>
                          <p class="price">£52.30</p>
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="radio"
                              name="shipping.carrier"
                              id="fedex-priority"
                              value="FedEx"
                              data-service="Priority"
                              data-rate="52.30"
                            />
                            <label class="form-check-label" for="fedex-priority"
                              >Select</label
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100 shipping-option">
                        <div class="card-body">
                          <h5 class="card-title">UPS Ground</h5>
                          <p class="card-text">Delivery in 2-3 business days</p>
                          <p class="price">£38.95</p>
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="radio"
                              name="shipping.carrier"
                              id="ups-ground"
                              value="UPS"
                              data-service="Ground"
                              data-rate="38.95"
                            />
                            <label class="form-check-label" for="ups-ground"
                              >Select</label
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Payment Method -->
                <div class="payment-method mb-4">
                  <h4 class="mb-3">Payment Method</h4>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="payment.method"
                          id="credit-card"
                          value="credit_card"
                          checked
                        />
                        <label class="form-check-label" for="credit-card">
                          Credit/Debit Card
                        </label>
                      </div>
                      <div class="card-payment-fields">
                        <div class="mb-3">
                          <label for="card-number" class="form-label"
                            >Card Number</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="card-number"
                            placeholder="XXXX XXXX XXXX XXXX"
                          />
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label for="expiry-date" class="form-label"
                              >Expiry Date</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="expiry-date"
                              placeholder="MM/YY"
                            />
                          </div>
                          <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input
                              type="text"
                              class="form-control"
                              id="cvv"
                              placeholder="XXX"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="payment.method"
                          id="paypal"
                          value="paypal"
                        />
                        <label class="form-check-label" for="paypal">
                          PayPal
                        </label>
                      </div>
                      <div class="paypal-fields d-none">
                        <p>
                          You will be redirected to PayPal to complete your
                          payment after submission.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary mb-4">
                  <h4 class="mb-3">Order Summary</h4>
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between mb-2">
                        <span>Shipping Cost:</span>
                        <span id="shipping-cost">£45.75</span>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>Insurance:</span>
                        <span id="insurance-cost">£0.00</span>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>VAT (20%):</span>
                        <span id="tax-amount">£9.15</span>
                      </div>
                      <hr />
                      <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong id="total-amount">£54.90</strong>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-between">
                  <button
                    type="button"
                    class="btn btn-outline-secondary prev-section"
                    data-prev="package-info-section"
                  >
                    Back
                  </button>
                  <button type="submit" class="btn btn-success btn-lg">
                    Create Shipment
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .create-shipment-container {
    background-color: #f8f9fa;
    min-height: 100vh;
  }

  .section-title {
    color: #2a9d8f;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
  }

  .progress-indicator {
    margin-bottom: 2rem;
  }

  .progress {
    height: 8px;
    border-radius: 4px;
  }

  .progress-step {
    font-size: 0.9rem;
    color: #6c757d;
  }

  .progress-step.active {
    color: #2a9d8f;
    font-weight: 600;
  }

  .shipping-option {
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .shipping-option:hover {
    border-color: #2a9d8f;
  }

  .shipping-option .price {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2a9d8f;
  }

  .card-header {
    background-color: #2a9d8f;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Progress bar and section navigation
    const progressBar = document.querySelector(".progress-bar");
    const sections = document.querySelectorAll(".section-wrapper");
    const progressSteps = document.querySelectorAll(".progress-step");

    // Next section buttons
    document.querySelectorAll(".next-section").forEach((button) => {
      button.addEventListener("click", function () {
        const currentSection = this.closest(".section-wrapper");
        const nextSectionId = this.dataset.next;
        const nextSection = document.getElementById(nextSectionId);

        // Hide current section
        currentSection.classList.add("d-none");

        // Show next section
        nextSection.classList.remove("d-none");

        // Update progress bar
        const progress =
          (Array.from(sections).findIndex(
            (section) => section.id === nextSectionId
          ) *
            100) /
          (sections.length - 1);
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute("aria-valuenow", progress);

        // Update active step
        progressSteps.forEach((step, index) => {
          if (
            index <=
            Array.from(sections).findIndex(
              (section) => section.id === nextSectionId
            )
          ) {
            step.classList.add("active");
          } else {
            step.classList.remove("active");
          }
        });
      });
    });

    // Previous section buttons
    document.querySelectorAll(".prev-section").forEach((button) => {
      button.addEventListener("click", function () {
        const currentSection = this.closest(".section-wrapper");
        const prevSectionId = this.dataset.prev;
        const prevSection = document.getElementById(prevSectionId);

        // Hide current section
        currentSection.classList.add("d-none");

        // Show previous section
        prevSection.classList.remove("d-none");

        // Update progress bar
        const progress =
          (Array.from(sections).findIndex(
            (section) => section.id === prevSectionId
          ) *
            100) /
          (sections.length - 1);
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute("aria-valuenow", progress);

        // Update active step
        progressSteps.forEach((step, index) => {
          if (
            index <=
            Array.from(sections).findIndex(
              (section) => section.id === prevSectionId
            )
          ) {
            step.classList.add("active");
          } else {
            step.classList.remove("active");
          }
        });
      });
    });

    // Insurance checkbox toggle
    const insuranceCheckbox = document.getElementById("insurance-required");
    const insuranceValue = document.querySelector(".insurance-value");

    insuranceCheckbox.addEventListener("change", function () {
      if (this.checked) {
        insuranceValue.classList.remove("d-none");
      } else {
        insuranceValue.classList.add("d-none");
      }
    });

    // Payment method toggle
    const creditCardRadio = document.getElementById("credit-card");
    const paypalRadio = document.getElementById("paypal");
    const cardFields = document.querySelector(".card-payment-fields");
    const paypalFields = document.querySelector(".paypal-fields");

    creditCardRadio.addEventListener("change", function () {
      if (this.checked) {
        cardFields.classList.remove("d-none");
        paypalFields.classList.add("d-none");
      }
    });

    paypalRadio.addEventListener("change", function () {
      if (this.checked) {
        cardFields.classList.add("d-none");
        paypalFields.classList.remove("d-none");
      }
    });

    // Shipping option selection and price update
    const shippingOptions = document.querySelectorAll(
      'input[name="shipping.carrier"]'
    );
    const shippingCost = document.getElementById("shipping-cost");
    const taxAmount = document.getElementById("tax-amount");
    const totalAmount = document.getElementById("total-amount");

    shippingOptions.forEach((option) => {
      option.addEventListener("change", function () {
        if (this.checked) {
          const rate = parseFloat(this.dataset.rate);
          const tax = rate * 0.2;
          const total = rate + tax;

          shippingCost.textContent = `£${rate.toFixed(2)}`;
          taxAmount.textContent = `£${tax.toFixed(2)}`;
          totalAmount.textContent = `£${total.toFixed(2)}`;
        }
      });
    });

    // Form submission
    const form = document.getElementById("create-shipment-form");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // Collect form data
      const formData = new FormData(form);
      const shipmentData = {};

      for (const [key, value] of formData.entries()) {
        const keys = key.split(".");
        let current = shipmentData;

        for (let i = 0; i < keys.length - 1; i++) {
          if (!current[keys[i]]) {
            current[keys[i]] = {};
          }
          current = current[keys[i]];
        }

        current[keys[keys.length - 1]] = value;
      }

      // Add selected shipping info
      const selectedShipping = document.querySelector(
        'input[name="shipping.carrier"]:checked'
      );
      if (selectedShipping) {
        if (!shipmentData.shipping) shipmentData.shipping = {};
        shipmentData.shipping.service = selectedShipping.dataset.service;
        shipmentData.shipping.rate = {
          value: parseFloat(selectedShipping.dataset.rate),
          currency: "GBP",
        };
      }

      // Send data to server
      fetch("/shipment/create/process-payment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(shipmentData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Redirect to tracking page
            window.location.href = data.redirectTo;
          } else {
            alert(data.message || "An error occurred");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred while creating your shipment");
        });
    });
  });
</script>
